# Stripe Invoice Sync Guide

## Problem Solved
When invoices are sent via Stripe dashboard, they weren't automatically updating in your admin panel because:
1. Webhooks don't work in local development without Stripe CLI or ngrok
2. There was no manual way to sync invoice data from Stripe

## Solution Implemented

### 1. Manual Sync Endpoints

#### Sync Single Invoice
**Endpoint:** `POST /api/admin/invoices/[id]/sync`

Fetches the latest data for a specific invoice from Stripe and updates your database.

#### Sync All Invoices
**Endpoint:** `POST /api/admin/invoices/sync-all`

Syncs all invoices that have a Stripe invoice ID from Stripe to your database.

### 2. UI Improvements

#### Admin Invoices Tab (`/admin`)
- **"Sync from Stripe" button** in the header - syncs ALL invoices at once
- **Individual sync buttons** for each invoice (refresh icon) - syncs that specific invoice
- Status updates automatically after sync
- PDF URLs and hosted invoice URLs get updated

### 3. Enhanced Logging

All sync operations now log detailed information:
- Invoice ID, status, and number
- PDF URL and hosted URL availability
- User lookup and matching
- Line items synced
- Any errors encountered

### 4. Improved Webhook Handler

The webhook now handles:
- `invoice.created`
- `invoice.updated`
- `invoice.finalized`
- `invoice.sent` (NEW - fired when invoice is emailed to client)
- `invoice.paid`
- `payment_intent.succeeded`
- `payment_intent.payment_failed`

## How to Use

### When You Send an Invoice in Stripe:

1. **Option 1: Manual Sync (Recommended for Local Development)**
   - Go to your Admin Dashboard → Invoices tab
   - Click the "Sync from Stripe" button to sync all invoices
   - OR click the refresh icon next to the specific invoice

2. **Option 2: Set Up Stripe Webhooks (for Production)**
   - Go to Stripe Dashboard → Developers → Webhooks
   - Add endpoint: `https://yourdomain.com/api/webhooks/stripe`
   - Select events to listen to (listed above)
   - Copy webhook secret to `.env` as `STRIPE_WEBHOOK_SECRET`

3. **Option 3: Stripe CLI (for Local Development)**
   ```bash
   stripe listen --forward-to localhost:3000/api/webhooks/stripe
   ```

### What Gets Synced:

When you sync an invoice, the following data updates:
- ✅ Invoice status (Draft → Sent → Paid)
- ✅ Invoice number (once finalized)
- ✅ PDF URL (generated by Stripe when sent)
- ✅ Hosted invoice URL (shareable link)
- ✅ Payment intent details
- ✅ Line items
- ✅ Due dates and amounts

## Troubleshooting

### Invoice not showing up?
1. Check if the invoice was created with the correct client email
2. Verify the client exists in your `users` table
3. Look for error logs in the console

### Status not updating?
1. Click the sync button to manually refresh
2. Check browser console for errors
3. Verify the invoice has a `stripe_invoice_id` in the database

### No PDF URL?
- PDFs are only generated when the invoice is finalized/sent
- Draft invoices won't have PDFs
- Click sync after sending the invoice in Stripe

## Testing Flow

1. Create an invoice from Admin → Clients → [Client Detail] → Add Invoice button
2. Go to Stripe Dashboard and find the draft invoice
3. Send the invoice (this finalizes it and emails the client)
4. Return to your admin panel and click "Sync from Stripe"
5. Verify:
   - Status changed from "Draft" to "Sent"
   - PDF URL is now available
   - Hosted invoice URL (⚡ icon) works
   - Invoice number is assigned

## Notes

- The sync is one-way: Stripe → Your Database
- Invoices created in your app are automatically synced to Supabase
- Manual edits in your database won't sync to Stripe
- Always use Stripe as the source of truth for invoice status

